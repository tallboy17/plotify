<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plotify - Pro Garden Planner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c6b4b;
            --secondary-color: #f4f7f6;
            --text-color: #333;
            --light-gray: #dde1e6;
            --white: #fff;
            --border-radius: 10px;
            --box-shadow: 0 2px 8px rgba(0, 0, 0, 0.07);
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: var(--secondary-color);
            color: var(--text-color);
            line-height: 1.6;
            overflow: hidden; /* Prevent body scroll */
        }

        .app-container {
            display: grid;
            grid-template-columns: 320px 1fr 400px;
            grid-template-rows: 60px 1fr;
            height: 100vh;
            grid-template-areas:
                "header header header"
                "search results details";
        }

        header {
            grid-area: header;
            background: var(--white);
            padding: 0 2rem;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--box-shadow);
            z-index: 10;
            position: relative;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .logo-icon {
            font-size: 1.6rem;
        }
        .logo-text {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        .project-name {
            font-weight: 500;
            color: #555;
            font-size: 1.2rem;
            padding-left: 0.75rem;
            margin-left: 0.25rem;
            border-left: 2px solid var(--light-gray);
        }

        header .header-actions {
            display: flex;
            gap: 1rem;
        }
        
        .pane {
            background-color: var(--white);
            height: calc(100vh - 60px);
            overflow-y: auto;
            border-right: 1px solid var(--light-gray);
            display: flex;
            flex-direction: column;
        }
        .pane:last-child {
            border-right: none;
        }

        /* Progress Bar */
        .progress-bar-container {
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: transparent;
            overflow: hidden;
            visibility: hidden;
            z-index: 11;
        }

        .progress-bar {
            width: 40%;
            height: 100%;
            background-color: var(--primary-color);
            animation: progressBarAnimation 1.5s ease-in-out infinite;
        }

        @keyframes progressBarAnimation {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(350%);
            }
        }

        /* Search Pane */
        .search-pane {
            grid-area: search;
            padding: 1.5rem;
            background-color: var(--secondary-color);
        }
        
        .search-pane h2 {
            margin-top: 0;
            font-size: 1.2rem;
        }

        .ai-assistant-info {
            font-size: 0.85rem;
            color: #555;
            margin-top: -0.5rem;
            margin-bottom: 1rem;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            overflow: hidden;
            background-color: var(--white);
            margin-bottom: 1.5rem;
        }
        .chat-container:focus-within {
             box-shadow: 0 0 0 2px var(--primary-color);
        }
        #chat-input {
            flex-grow: 1;
            border: none;
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
            outline: none;
            background: transparent;
            resize: none;
            height: 120px;
        }
        #chat-submit {
            border: none;
            background: var(--primary-color);
            color: var(--white);
            padding: 0.6rem 1.5rem;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            border-top: 1px solid var(--light-gray);
            transition: background-color 0.2s;
        }
        #chat-submit:disabled {
            background-color: #a5d6a7;
            cursor: not-allowed;
        }

        /* Results Pane */
        .results-pane {
            grid-area: results;
            padding: 1.5rem;
        }
        
        .results-controls {
            margin-bottom: 1.5rem;
        }

        .results-controls h4 {
            margin-top: 0;
            margin-bottom: 0.5rem;
            font-size: 1rem;
            color: #555;
        }

        .search-box-container {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .search-input {
            flex-grow: 1;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--light-gray);
            border-radius: 6px;
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.2s;
        }

        .search-input:focus {
            border-color: var(--primary-color);
        }

        .search-btn {
            padding: 0.5rem 1rem;
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .search-btn:hover {
            background-color: #1e4d2e;
        }

        .search-btn:disabled {
            background-color: #a5d6a7;
            cursor: not-allowed;
        }

        .ai-response-container {
            min-height: 80px;
            background-color: var(--secondary-color);
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            padding: 0.75rem 1rem;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            color: #333;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 1.5rem;
            align-content: start;
        }
        .plant-card {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            border: 2px solid transparent;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
        }
        .plant-card.selected {
            border-color: var(--primary-color);
        }
        .plant-card:hover {
             transform: translateY(-4px);
             box-shadow: 0 6px 16px rgba(0,0,0,0.1);
        }
        .plant-card-content { 
            padding: 1rem; 
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        .plant-card-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.75rem;
        }
        .plant-card-icon {
            font-size: 2.5rem;
            min-width: 40px;
            text-align: center;
        }
        .plant-card h3 {
            margin: 0 0 0.25rem 0;
            font-size: 1.1rem;
            color: var(--primary-color);
            line-height: 1.2;
        }
        .plant-card p { margin: 0; color: #666; font-size: 0.85rem; }
        .plant-card-description {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 1rem;
        }
        
        .card-actions {
            margin-top: auto;
            padding-top: 1rem;
            display: flex;
            gap: 0.5rem;
        }
        .card-btn {
            flex-grow: 1;
            padding: 0.5rem;
            font-size: 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            border: 1px solid var(--primary-color);
        }
        .card-btn.primary {
            background-color: var(--primary-color);
            color: var(--white);
        }
        .card-btn.secondary {
            background-color: var(--white);
            color: var(--primary-color);
        }
         .card-btn.secondary.remove {
            background-color: #fff0f0;
            color: #c62828;
            border-color: #c62828;
        }


        /* Details/Project Pane */
        .details-pane {
            grid-area: details;
            padding: 1.5rem;
        }

        .details-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: #888;
        }

        .details-placeholder-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .details-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        #back-to-project-btn {
             background: none;
             border: none;
             font-size: 1.5rem;
             cursor: pointer;
             color: #555;
        }

        .details-content h2 {
            margin: 0;
            font-size: 1.8rem;
            color: var(--primary-color);
        }
         .details-content h3 {
            font-style: italic;
            font-weight: 500;
            color: #555;
            margin: 0 0 1.5rem 0;
            border-bottom: 1px solid var(--light-gray);
            padding-bottom: 1rem;
        }
        .modal-details {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.5rem;
            margin: 1.5rem 0;
        }
        .modal-details p {
            margin: 0;
            padding: 0.5rem;
            border-left: 3px solid var(--primary-color);
            background-color: var(--secondary-color);
            font-size: 0.9rem;
        }
        .details-links {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }
        .details-links a {
            flex-grow: 1;
            text-align: center;
            padding: 0.6rem;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .google-link {
            background-color: #e8f5e9;
            color: #1a73e8;
            border: 1px solid #a5d6a7;
        }
        .youtube-link {
            background-color: #fce8e6;
            color: #c4302b;
            border: 1px solid #f7c5c3;
        }
        

        /* Project Zone Specific */
        #project-zone-left {
            border-top: 1px solid var(--light-gray);
            padding-top: 1rem;
            flex-grow: 1;
            overflow-y: auto;
            min-height: 150px;
        }
        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .project-header h2 {
            font-size: 1.2rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .project-header-icon {
            font-size: 1.5rem;
            color: var(--primary-color);
        }
        .item-count-badge {
            background-color: #e8f5e9;
            color: var(--primary-color);
            font-size: 0.8rem;
            padding: 0.2rem 0.6rem;
            border-radius: 20px;
            font-weight: 500;
        }
        .project-actions {
            display: flex;
            gap: 0.5rem;
        }
        .project-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .share-btn, .save-btn, .download-btn, .visualizer-btn {
             background-color: #4285F4;
             color: white;
        }
        .add-zone-btn, .expand-btn {
            background-color: var(--secondary-color);
            border: 1px solid var(--light-gray);
            color: var(--text-color);
        }

        .project-help-text {
            font-size: 0.8rem;
            color: #666;
            margin: 0.5rem 0 1rem 0;
            text-align: center;
            padding: 0.5rem;
            background-color: #e8f5e9;
            border-radius: 6px;
        }

        .zone {
            margin-bottom: 1rem;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            background: #fafafa;
        }
        .zone.drag-over {
            border-color: var(--primary-color);
            background: #e8f5e9;
        }
        .zone-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background: var(--secondary-color);
            border-bottom: 1px solid var(--light-gray);
        }
        .zone-title-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-grow: 1;
        }
        .zone-header h4 { margin: 0; font-size: 0.9rem;}
        .zone-name-input {
            font-size: 0.9rem;
            padding: 2px 4px;
            border: 1px solid var(--primary-color);
            border-radius: 4px;
            width: 70%;
        }
        .zone-header-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .edit-zone-btn {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 0.9rem;
            padding: 0;
        }
        .edit-zone-btn:hover { color: var(--primary-color); }
        .delete-zone-btn { background:none; border:none; color:#999; cursor:pointer; font-size: 1.2rem; }
        .delete-zone-btn:hover { color: #d32f2f; }

        .zone-plant-list, .unassigned-list {
            list-style: none;
            padding: 0.5rem;
            min-height: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        .project-plant-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            background: white;
            border-radius: 6px;
            box-shadow: var(--box-shadow);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            cursor: grab;
        }
        .project-plant-item:active { cursor: grabbing; }
        .project-plant-item .project-item-icon { margin-right: 0.75rem; font-size: 1.5rem; }
        .project-plant-item button {
            margin-left: auto;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            color: #999;
        }
        .project-plant-item button:hover { color: #d32f2f; }
        
        /* Plot Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content-large {
            background-color: var(--white);
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 1200px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 { margin: 0; font-size: 1.3rem; }
        #close-plot-modal-btn {
            background: none; border: none; font-size: 1.8rem;
            cursor: pointer; color: #888;
        }
        #modal-plot-container {
            padding: 1.5rem;
            overflow-y: auto;
            flex-grow: 1;
        }
        #modal-plot-container .plot-zones-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        /* Small utility for copied message */
        .copied-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .app-container {
                grid-template-columns: 280px 1fr 350px;
            }
        }
        @media (max-width: 900px) {
             .app-container {
                grid-template-columns: 1fr;
                grid-template-rows: 60px auto 1fr auto;
                grid-template-areas:
                    "header"
                    "search"
                    "results"
                    "details";
            }
            .pane {
                 height: auto;
                 border-right: none;
                 border-bottom: 1px solid var(--light-gray);
            }
            .search-pane {
                 flex-direction: column;
            }
            #project-zone-left {
                width: 100%;
                margin-top: 1.5rem;
            }
        }

    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <div class="logo-container">
                <span class="logo-icon">🪴</span>
                <span class="logo-text">Plotify Pro</span>
                <a href="/users/projects" class="project-name">Dashboard</a>
                <span class="project-name" id="project-name-display"></span>
            </div>
            <input type="hidden" id="project-id" value="">
            <div class="header-actions">
                <button class="project-btn visualizer-btn" id="visualizer-btn">Visualizer</button>
                <button class="project-btn download-btn" id="download-project-btn">Download Project</button>
                <button class="project-btn save-btn" id="save-project-btn">Save Project</button>
                <button class="project-btn share-btn" id="share-project-btn">Share Project</button>
                <button class="project-btn logout-btn" id="logout-btn">Logout</button>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar"></div>
            </div>
        </header>

        <aside class="pane search-pane">
            <div>
                <h2>AI Assistant</h2>
                <p class="ai-assistant-info">Ask questions or describe the plants you're looking for.</p>
                <div class="chat-container">
                    <textarea id="chat-input" placeholder="e.g., show me flowering shrubs that are low water and good for beginners..." rows="4"></textarea>
                    <button id="chat-submit" aria-label="Submit search query">Ask Assistant</button>
                </div>
            </div>
            <div id="project-zone-left">
                <!-- My Plot will be rendered here -->
            </div>
        </aside>

        <main class="pane results-pane">
            <div class="results-controls">
                <h4>AI Assistant Response</h4>
                 <div id="ai-response-container" class="ai-response-container">
                    <p>AI assistant response will appear here. Plant results below will update based on the conversation.</p>
                </div>
                <h4>Search Plants</h4>
                <div class="search-box-container">
                    <input type="text" id="search-input" class="search-input" placeholder="Search for plants..." value="shady">
                    <button id="search-btn" class="search-btn">Search</button>
                </div>
            </div>
             <div id="plant-results" class="results-grid">
                <!-- Plant cards will be injected here -->
            </div>
        </main>

        <aside class="pane details-pane" id="details-pane">
            <!-- Details will be rendered here -->
        </aside>
    </div>

    <!-- Expanded Plot Modal -->
    <div id="plot-modal" class="modal-overlay">
        <div class="modal-content-large">
            <div class="modal-header">
                <h2>Expanded Plot View</h2>
                <button id="close-plot-modal-btn" title="Close">&times;</button>
            </div>
            <div id="modal-plot-container">
                <!-- Expanded plot content will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Inline Confirm Modal -->
    <div id="inline-confirm-modal" class="modal-overlay">
        <div class="modal-content-large" style="max-width: 400px; height: auto; text-align: center;">
             <div id="modal-confirm-container" style="padding: 2rem;">
                <p style="font-size: 1.1rem; margin-top: 0; margin-bottom: 1.5rem;">Are you sure you want to delete this zone?</p>
                <div>
                    <button id="confirm-delete-btn" class="project-btn" style="background-color: #d32f2f; color: white;">Yes, Delete</button>
                    <button id="cancel-delete-btn" class="project-btn add-zone-btn">Cancel</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Logout functionality
            document.getElementById('logout-btn').addEventListener('click', () => {
                localStorage.removeItem('jwt_token');
                localStorage.removeItem('user_id');
                window.location.href = '/';
            });
            
            // Set up periodic token validation (every 5 minutes)
            setInterval(() => {
                const token = localStorage.getItem('jwt_token');
                if (token) {
                    try {
                        const payload = JSON.parse(atob(token.split('.')[1]));
                        const currentTime = Math.floor(Date.now() / 1000);
                        
                        if (payload.exp && payload.exp < currentTime) {
                            console.log('Token has expired, clearing localStorage');
                            localStorage.removeItem('jwt_token');
                            localStorage.removeItem('user_id');
                            alert('Session expired. Please login again.');
                            window.location.href = '/';
                        }
                    } catch (error) {
                        console.error('Error validating token:', error);
                        localStorage.removeItem('jwt_token');
                        localStorage.removeItem('user_id');
                    }
                }
            }, 5 * 60 * 1000); // 5 minutes
            
            // DOM Elements
            const chatInput = document.getElementById('chat-input');
            const chatSubmit = document.getElementById('chat-submit');
            const resultsContainer = document.getElementById('plant-results');
            const detailsPane = document.getElementById('details-pane');
            const searchInput = document.getElementById('search-input');
            const searchBtn = document.getElementById('search-btn');
            const projectZoneLeft = document.getElementById('project-zone-left');
            const aiResponseContainer = document.getElementById('ai-response-container');
            const plotModal = document.getElementById('plot-modal');
            const closePlotModalBtn = document.getElementById('close-plot-modal-btn');
            const modalPlotContainer = document.getElementById('modal-plot-container');
            const progressBarContainer = document.querySelector('.progress-bar-container');
            const inlineConfirmModal = document.getElementById('inline-confirm-modal');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            const downloadProjectBtn = document.getElementById('download-project-btn');
            const projectNameDisplay = document.getElementById('project-name-display');
            const projectIdInput = document.getElementById('project-id');


            // --- CONFIGURATION FLAG ---
            const useMockApi = false; // Set to false to use the live /search endpoint

            // App State
            let plantDataCache = {}; // Cache of all plant objects seen so far, using ID as key
            let currentSearchIds = []; // Array of plant IDs from the last search
            let projectData = {
                plants: {}, // { plantId: { zoneId: null | zoneId, ...plantData } }
                zones: [], // { id: zoneId, name: 'Zone Name' }
                nextZoneId: 1,
            };
            let projectMetadata = {
                project_name: '',
                project_id: '',
                user_id: '',
                status: 'in-progress',
                description: '',
                client: '',
                startDate: '',
                completedDate: null
            };
            let selectedPlantId = null;
            let zoneToDeleteId = null;

            // --- INITIALIZATION ---
            async function init() {
                // Extract project ID from URL path /users/projects/:id
                const pathParts = window.location.pathname.split('/');
                const projectId = pathParts[pathParts.length - 1];
                
                console.log('URL path:', window.location.pathname);
                console.log('Extracted project ID:', projectId);

                await loadProjectDataFromBackend(projectId); 

                const defaultQuery = "what are some popular plants for shady areas?";
                chatInput.value = defaultQuery;
                aiSearch(defaultQuery); 
                renderRightPane();
                renderProject(projectZoneLeft);
                setupDragAndDrop(projectZoneLeft);
                setupDragAndDrop(modalPlotContainer);
            }
            
            async function loadProjectDataFromBackend(projectId) {
                if (!projectId) {
                    projectNameDisplay.textContent = "No Project Loaded";
                    projectIdInput.value = '';
                    return;
                }
                
                projectIdInput.value = projectId;
                progressBarContainer.style.visibility = 'visible';

                try {
                    const token = localStorage.getItem('jwt_token');
                    if (!token) {
                        alert('Please login first');
                        window.location.href = '/';
                        return;
                    }
                    
                    // Check if token is expired
                    try {
                        const payload = JSON.parse(atob(token.split('.')[1]));
                        const currentTime = Math.floor(Date.now() / 1000);
                        
                        if (payload.exp && payload.exp < currentTime) {
                            console.log('Token has expired, clearing localStorage');
                            localStorage.removeItem('jwt_token');
                            localStorage.removeItem('user_id');
                            alert('Session expired. Please login again.');
                            window.location.href = '/';
                            return;
                        }
                    } catch (error) {
                        console.error('Error validating token:', error);
                        localStorage.removeItem('jwt_token');
                        localStorage.removeItem('user_id');
                        alert('Invalid token. Please login again.');
                        window.location.href = '/';
                        return;
                    }

                    let backendData;
                    if (useMockApi) {
                         // Mock backend response:
                        backendData = {
                            "project_name": "Front Yard Redesign (Mock)",
                            "project_id": "proj_def456",
                            "projectData": {
                                "plants": {
                                    "e98c412e-6621-44c1-8221-dab9b482299e": { "plant_id": "e98c412e-6621-44c1-8221-dab9b482299e", "common_name": "Anigozanthos 'Bush Tango'", "zoneId": 1 },
                                    "9ef91e42-a19c-4f26-95d1-a77c597d589f": { "plant_id": "9ef91e42-a19c-4f26-95d1-a77c597d589f", "common_name": "Salvia chionophylla", "zoneId": 2 },
                                    "c83d66fd-d590-4272-969a-6e9d0fd41840": { "plant_id": "c83d66fd-d590-4272-969a-6e9d0fd41840", "common_name": "Ceanothus gloriosus 'Anchor Bay'", "zoneId": 2 }
                                },
                                "zones": [
                                    { "id": 1, "name": "Entryway Planters" },
                                    { "id": 2, "name": "Drought-Tolerant Border" }
                                ],
                                "nextZoneId": 3
                            }
                        };
                    } else {
                        const response = await fetch(`/api/users/projects/${projectId}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (!response.ok) {
                            if (response.status === 401) {
                                alert('Session expired. Please login again.');
                                localStorage.removeItem('jwt_token');
                                localStorage.removeItem('user_id');
                                window.location.href = '/';
                                return;
                            }
                            throw new Error(`Failed to load project: ${response.status}`);
                        }
                        
                        backendData = await response.json();
                        console.log('Project data loaded from backend:', backendData);
                    }
                    
                    projectNameDisplay.textContent = backendData.project_name || 'Unnamed Project';
                    projectIdInput.value = backendData.project_id || projectId;

                    // Update project metadata
                    projectMetadata = {
                        project_name: backendData.project_name || 'Unnamed Project',
                        project_id: backendData.project_id || projectId,
                        user_id: backendData.user_id || localStorage.getItem('user_id'),
                        status: backendData.status || 'in-progress',
                        description: backendData.description || 'Garden project created with Plotify Pro',
                        client: backendData.client || 'Self',
                        startDate: backendData.startDate || new Date().toISOString().split('T')[0],
                        completedDate: backendData.completedDate || null
                    };

                    if (backendData.projectData && backendData.projectData.plants && backendData.projectData.zones) {
                        const dataToLoad = backendData.projectData;
                        const cleanedPlants = {};
                        Object.keys(dataToLoad.plants).forEach(plantId => {
                            const plant = dataToLoad.plants[plantId];
                            if (plant && plant.plant_id && plant.common_name) {
                                cleanedPlants[plantId] = plant;
                                if (!plantDataCache[plantId]) {
                                    plantDataCache[plantId] = plant;
                                }
                            }
                        });
                        dataToLoad.plants = cleanedPlants;
                        
                        // Ensure nextZoneId is preserved or set to a valid value
                        if (!dataToLoad.nextZoneId) {
                            // Calculate nextZoneId based on existing zones
                            const maxZoneId = dataToLoad.zones.length > 0 ? Math.max(...dataToLoad.zones.map(z => z.id)) : 0;
                            dataToLoad.nextZoneId = maxZoneId + 1;
                        }
                        
                        projectData = dataToLoad;
                    }

                } catch (error) {
                    console.error("Failed to load project data from backend:", error);
                    projectNameDisplay.textContent = "Error Loading Project";
                } finally {
                    progressBarContainer.style.visibility = 'hidden';
                }
            }
            
            async function saveProjectToBackend() {
                const projectId = projectIdInput.value;
                if (!projectId) {
                    alert("No project is loaded to save.");
                    return;
                }

                const token = localStorage.getItem('jwt_token');
                if (!token) {
                    alert('Please login first');
                    window.location.href = '/';
                    return;
                }

                progressBarContainer.style.visibility = 'visible';
                const saveBtn = document.getElementById('save-project-btn');
                const originalText = saveBtn.textContent;
                saveBtn.disabled = true;
                saveBtn.textContent = 'Saving...';

                try {
                    if (useMockApi) {
                        // Mocking successful save
                        await new Promise(resolve => setTimeout(resolve, 500)); 
                        showCopiedMessage("Project Saved (Mock)");
                    } else {
                        // Real API call
                        const response = await fetch(`/users/projects/${projectId}`, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                ...projectMetadata,
                                project_name: projectNameDisplay.textContent || projectMetadata.project_name,
                                project_id: projectId,
                                projectData: projectData
                            })
                        });

                        if (!response.ok) {
                            if (response.status === 401) {
                                alert('Session expired. Please login again.');
                                localStorage.removeItem('jwt_token');
                                localStorage.removeItem('user_id');
                                window.location.href = '/';
                                return;
                            }
                            
                            const errorData = await response.json().catch(() => ({}));
                            console.error('Save failed:', errorData);
                            throw new Error(`Failed to save project: ${response.status} - ${errorData.message || 'Unknown error'}`);
                        }
                        
                        const result = await response.json();
                        console.log('Project saved successfully:', result);
                        showCopiedMessage("Project Saved Successfully");
                    }

                } catch (error) {
                    console.error("Failed to save project:", error);
                    alert("Error saving project. Please try again.");
                } finally {
                     progressBarContainer.style.visibility = 'hidden';
                     saveBtn.disabled = false;
                     saveBtn.textContent = originalText;
                }
            }


            // --- RENDERING LOGIC ---
            function renderRightPane() {
                if (selectedPlantId) {
                    displayPlantDetails(selectedPlantId);
                } else {
                    displayDetailsPlaceholder();
                }
            }
            
            function displayPlants(plants) {
                resultsContainer.innerHTML = '';
                if (plants.length === 0) {
                    resultsContainer.innerHTML = '<p>No plants match your criteria.</p>';
                }
                plants.forEach(plant => {
                    const card = document.createElement('div');
                    card.className = `plant-card ${selectedPlantId === plant.plant_id ? 'selected' : ''}`;
                    card.dataset.plantId = plant.plant_id;
                    const isInProject = projectData.plants[plant.plant_id];
                    
                    card.innerHTML = `
                        <div class="plant-card-content">
                            <div class="plant-card-header">
                               <span class="plant-card-icon">🌱</span>
                               <div>
                                  <h3>${plant.common_name}</h3>
                                  <p>${plant.plant_type}</p>
                               </div>
                            </div>
                            <p class="plant-card-description">${plant.family || ''}</p>
                            <div class="card-actions">
                                <button class="card-btn secondary ${isInProject ? 'remove' : ''}" data-action="toggle-project" data-plant-id="${plant.plant_id}">${isInProject ? 'Remove' : 'Add to Plot'}</button>
                                <button class="card-btn primary" data-action="view-details" data-plant-id="${plant.plant_id}">Details</button>
                            </div>
                        </div>`;
                    resultsContainer.appendChild(card);
                });
            }

            function displayPlantDetails(plantId) {
                console.log('Displaying details for plantId:', plantId);
                const plant = plantDataCache[plantId]; // Use cache to find plant details
                if (!plant) {
                    selectedPlantId = null;
                    renderRightPane();
                    return;
                }
                
                const query = new URL(plant.youtube_link || 'https://www.youtube.com/results?search_query=plant+care').searchParams.get('search_query');
    
                
                detailsPane.innerHTML = `
                    <div class="details-content">
                        <div class="details-header">
                           <button id="back-to-project-btn" title="Back to Plot View">←</button>
                           <h2>${plant.common_name}</h2>
                        </div>
                        <h3>${plant.scientific_name}</h3>
                        <div class="modal-details">
                            <p><strong>Sun:</strong> ${plant.sun_exposure}</p>
                            <p><strong>Water:</strong> ${plant.water_requirements}</p>
                            <p><strong>Flower Color:</strong> ${plant.flower_color}</p>
                            <p><strong>Dimensions:</strong> ${plant.height} tall, ${plant.width} wide</p>
                            <p><strong>Hardiness Zone:</strong> ${plant.usda_hardiness_zone}</p>
                            <p><strong>Blooming Season:</strong> ${plant.blooming_season}</p>
                        </div>
                         <div class="details-links">
                            <a href="https://www.google.com/search?q=${encodeURIComponent(plant.common_name)}" target="_blank" class="google-link">Google Search</a>
                            <a href="${plant.youtube_link}" target="_blank" class="youtube-link">YouTube</a>
                        </div>
                    </div>`;
            }
            
            function displayDetailsPlaceholder() {
                detailsPane.innerHTML = `
                    <div class="details-placeholder">
                        <div class="details-placeholder-icon">🌱</div>
                        <p>Select a plant to view its details here.</p>
                    </div>`;
            }

            function renderProject(container, isModalView = false) {
                const plantCount = Object.keys(projectData.plants).length;
                let unassignedContent = `
                     <div class="zone" data-zone-id="null">
                        <div class="zone-header">
                            <div class="zone-title-container"><h4>Unassigned</h4></div>
                        </div>
                        <ul class="unassigned-list zone-plant-list" data-zone-id="null">
                            ${getPlantsForZone(null)}
                        </ul>
                    </div>`;

                let zonesContent = projectData.zones.map(zone => `
                    <div class="zone" data-zone-id="${zone.id}">
                        <div class="zone-header">
                            <div class="zone-title-container">
                                <h4>${zone.name}</h4>
                            </div>
                            <div class="zone-header-actions">
                                <button class="edit-zone-btn" data-zone-id="${zone.id}">✏️</button>
                                <button class="delete-zone-btn" data-zone-id="${zone.id}">&times;</button>
                            </div>
                        </div>
                        <ul class="zone-plant-list" data-zone-id="${zone.id}">
                            ${getPlantsForZone(zone.id)}
                        </ul>
                    </div>`).join('');
                
                let projectContent = `
                    <div class="project-header">
                        <h2><span class="project-header-icon">🌳</span> My Plot</h2>
                        <span class="item-count-badge">${plantCount} items</span>
                    </div>
                    <div class="project-actions">
                         <button class="project-btn add-zone-btn" data-action="add-zone">+ Add Zone</button>
                         ${!isModalView ? '<button class="project-btn expand-btn" data-action="expand-plot">Expand ↗</button>' : ''}
                    </div>
                    ${plantCount > 0 ? `<p class="project-help-text">💡 Drag plants to organize into zones.</p>` : ''}
                    ${unassignedContent}
                    ${isModalView ? `<div class="plot-zones-grid">${zonesContent}</div>` : zonesContent}
                `;


                container.innerHTML = projectContent;
            }

            function getPlantsForZone(zoneId) {
                let plantHtml = '';
                const plantsInZone = Object.values(projectData.plants).filter(plant => plant && plant.zoneId === zoneId);

                if (plantsInZone.length === 0) return '<li><small style="color: #888; padding-left: 0.5rem;">No plants in this zone.</small></li>';

                plantsInZone.forEach(plant => {
                    if (plant && plant.plant_id && plant.common_name) {
                        plantHtml += `
                            <li class="project-plant-item" draggable="true" data-plant-id="${plant.plant_id}">
                                <span class="project-item-icon">🪴</span>
                                <span>${plant.common_name}</span>
                                <button class="remove-from-project-btn" data-plant-id="${plant.plant_id}" title="Remove">&times;</button>
                            </li>`;
                    }
                });
                
                if (!plantHtml) {
                    return '<li><small style="color: #888; padding-left: 0.5rem;">No plants in this zone.</small></li>';
                }

                return plantHtml;
            }

            async function searchPlants(query) {
                if (!query.trim()) return;
                
                searchBtn.disabled = true;
                searchBtn.textContent = 'Searching...';
                
                const fetchUrl = `/q?q=${encodeURIComponent(query)}`;
                console.log('Searching with URL:', fetchUrl);
                console.log('Query:', query);
                
                try {
                    const response = await fetch(fetchUrl);
                    console.log('Response status:', response.status);
                    console.log('Response headers:', response.headers);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    console.log('Response data:', data);
                    
                    currentSearchIds = [];
                    if (data.results) {
                        console.log('Found plants:', data.results.length);
                        data.results.forEach(plant => {
                            plantDataCache[plant.plant_id] = plant;
                            currentSearchIds.push(plant.plant_id);
                        });
                    } else {
                        console.log('No plants in response');
                    }
                    filterAndDisplayPlants();
                    
                    if (data.response) {
                        aiResponseContainer.innerHTML = `<p>${data.response}</p>`;
                    }
                    
                } catch (error) {
                    console.error('Search error:', error);
                    console.error('Error details:', error.message);
                    aiResponseContainer.innerHTML = `<p style="color: #c62828;">Search failed. Please try again.</p>`;
                } finally {
                    searchBtn.disabled = false;
                    searchBtn.textContent = 'Search';
                }
            }

            // --- API & State Logic ---
            
            function getMockData(query) {
                 return new Promise((resolve) => {
                    setTimeout(() => {
                        const hardcodedData = {
                            "response":"For shady areas, you have many lovely options! Consider hostas, astilbes, ferns, or even some varieties of impatiens. These are all known to thrive in lower-light conditions.",
                            "plants":[
                                {"plant_id":"468cd53e-fe3b-4809-a987-0f230235b157","common_name":"Abelia x grandiflora 'Kaleidoscope' PP16,988","youtube_link":"https://www.youtube.com/results?search_query=Abelia+x+grandiflora+'Kaleidoscope'+PP16,988","wikipedia_link":"https://en.wikipedia.org/wiki/Abelia_x_grandiflora_'Kaleidoscope'_PP16,988","smg_link":"https://www.smgrowers.com/products/plants/plantdisplay.asp?plant_id=2945","source":"San Marcos Growers","scientific_name":"Abelia x grandiflora 'Kaleidoscope' PP16,988","family":"Caprifoliaceae (Honeysuckles)","plant_type":"Shrub","sun_exposure":"Sun or Shade","water_requirements":"Medium Water Needs","flower_color":"White","height":"2-3 feet","width":"3-4 feet","usda_hardiness_zone":"Unknown","blooming_season":"Summer/Fall","evergreen":"Yes","synonyms":"Unknown"},
                                {"plant_id":"a04cef6e-b382-41bd-86c6-06733c0d6626","common_name":"Abutilon pictum 'Thompsonii'","youtube_link":"https://www.youtube.com/results?search_query=Abutilon+pictum+'Thompsonii'","wikipedia_link":"https://en.wikipedia.org/wiki/Abutilon_pictum_'Thompsonii'","smg_link":"https://www.smgrowers.com/products/plants/plantdisplay.asp?plant_id=4743","source":"San Marcos Growers","scientific_name":"Abutilon pictum 'Thompsonii'","family":"Malvaceae (w/Bombacaceae & Sterculeacea)","plant_type":"Shrub","sun_exposure":"Cool Sun/Light Shade","water_requirements":"Medium Water Needs","flower_color":"Apricot Pink","height":"6-10 feet","width":"4-6 feet","usda_hardiness_zone":"20-25° F","blooming_season":"Year-round","evergreen":"Yes","synonyms":"[A. striatum, Callianthe striata]"},
                                {"plant_id":"774f51bb-2caa-4f1a-b561-16540e295365","common_name":"Acacia aphylla","youtube_link":"https://www.youtube.com/results?search_query=Acacia+aphylla","wikipedia_link":"https://en.wikipedia.org/wiki/Acacia_aphylla","smg_link":"https://www.smgrowers.com/products/plants/plantdisplay.asp?plant_id=4657","source":"San Marcos Growers","scientific_name":"Acacia aphylla","family":"Mimosaceae (~Fabales)","plant_type":"Shrub","sun_exposure":"Sun or Shade","water_requirements":"Low Water Needs","flower_color":"Yellow","height":"6-8 feet","width":"4-6 feet","usda_hardiness_zone":"20-25° F","blooming_season":"Winter/Spring","evergreen":"Yes","synonyms":"Unknown"}
                            ]
                        };
                        resolve(hardcodedData);
                    }, 800);
                });
            }

            async function aiSearch(query) {
                selectedPlantId = null;
                renderRightPane();

                progressBarContainer.style.visibility = 'visible';
                chatSubmit.disabled = true;

                try {
                    let result;
                    if (useMockApi) {
                        result = await getMockData(query);
                    } else {
                        try {
                            const response = await fetch('/search', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ query: query, context: "" })
                            });
                            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                            result = await response.json();
                        } catch (liveError) {
                            console.error("Live API call failed, falling back to mock data:", liveError);
                            aiResponseContainer.innerHTML = `<p style="color: #c62828;">Could not connect to the AI Assistant. Displaying sample data as a fallback.</p>`;
                            result = await getMockData(query);
                        }
                    }

                    aiResponseContainer.innerHTML = `<p>${result.response || 'Here are the plants based on your request.'}</p>`;
                    
                    if (result.search_phrase) {
                        searchInput.value = result.search_phrase;
                    }
                    
                    const newPlants = result.plants || [];
                    currentSearchIds = [];
                    newPlants.forEach(plant => {
                        plantDataCache[plant.plant_id] = plant;
                        currentSearchIds.push(plant.plant_id);
                    });
                    filterAndDisplayPlants();

                } catch (error) {
                    console.error("General error in aiSearch:", error);
                    aiResponseContainer.innerHTML = `<p style="color: red;">An unexpected error occurred.</p>`;
                    currentSearchIds = [];
                    displayPlants([]);
                } finally {
                    progressBarContainer.style.visibility = 'hidden';
                    chatSubmit.disabled = false;
                }
            }

            function filterAndDisplayPlants() {
                let plantsToDisplay = currentSearchIds.map(id => plantDataCache[id]).filter(Boolean);
                displayPlants(plantsToDisplay);
            }

            function toggleProjectPlant(plantId) {
                if (projectData.plants[plantId]) {
                    delete projectData.plants[plantId];
                } else {
                    const plantInfo = plantDataCache[plantId];
                    if (plantInfo) {
                         projectData.plants[plantId] = { ...plantInfo, zoneId: null };
                    }
                }
                filterAndDisplayPlants();
                renderProject(projectZoneLeft);
                if (plotModal.style.display === 'flex') {
                    renderProject(modalPlotContainer, true);
                }
            }
            
            function addZone() {
                const zoneName = `Zone ${projectData.nextZoneId}`;
                projectData.zones.push({ id: projectData.nextZoneId, name: zoneName });
                projectData.nextZoneId++;
                renderProject(projectZoneLeft);
                if (plotModal.style.display === 'flex') {
                    renderProject(modalPlotContainer, true);
                }
            }

            function confirmDeleteZone() {
                if (zoneToDeleteId === null) return;

                Object.keys(projectData.plants).forEach(plantId => {
                    if (projectData.plants[plantId].zoneId === zoneToDeleteId) {
                        projectData.plants[plantId].zoneId = null;
                    }
                });
                projectData.zones = projectData.zones.filter(z => z.id !== zoneToDeleteId);
                
                renderProject(projectZoneLeft);
                if (plotModal.style.display === 'flex') {
                    renderProject(modalPlotContainer, true);
                }
                
                inlineConfirmModal.style.display = 'none';
                zoneToDeleteId = null;
            }

            function movePlantToZone(plantId, zoneId) {
                if (projectData.plants[plantId]) {
                    projectData.plants[plantId].zoneId = zoneId;
                    renderProject(projectZoneLeft);
                     if (plotModal.style.display === 'flex') {
                        renderProject(modalPlotContainer, true);
                    }
                }
            }

            function openPlotModal() {
                renderProject(modalPlotContainer, true);
                plotModal.style.display = 'flex';
            }
            
            function closePlotModal() {
                plotModal.style.display = 'none';
                renderProject(projectZoneLeft);
            }
            
            function downloadProjectAsCSV() {
                if (Object.keys(projectData.plants).length === 0) {
                    alert("Your plot is empty. Add some plants before downloading.");
                    return;
                }

                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Zone Name,Plant Common Name,Scientific Name\r\n";

                const escapeCSV = (str) => `"${String(str || '').replace(/"/g, '""')}"`;

                const unassignedPlants = Object.values(projectData.plants).filter(p => p.zoneId === null);
                unassignedPlants.forEach(plant => {
                    const row = ["Unassigned", escapeCSV(plant.common_name), escapeCSV(plant.scientific_name)].join(",");
                    csvContent += row + "\r\n";
                });

                projectData.zones.forEach(zone => {
                    const plantsInZone = Object.values(projectData.plants).filter(p => p.zoneId === zone.id);
                    plantsInZone.forEach(plant => {
                        const row = [escapeCSV(zone.name), escapeCSV(plant.common_name), escapeCSV(plant.scientific_name)].join(",");
                        csvContent += row + "\r\n";
                    });
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                const projectName = projectNameDisplay.textContent.replace('🪴', '').trim() || 'plotify-project';
                link.setAttribute("download", `${projectName}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }


            function generateShareUrl() {
                try {
                    const dataStr = JSON.stringify(projectData);
                    const encoded = btoa(dataStr);
                    const url = `${window.location.origin}${window.location.pathname}?project=${encoded}`;
                    navigator.clipboard.writeText(url).then(() => showCopiedMessage("Share URL copied to clipboard!"));
                } catch (e) { console.error("Failed to generate share URL", e); alert("Could not generate share URL."); }
            }
            
            function showCopiedMessage(message) {
                const existingMsg = document.querySelector('.copied-message');
                if(existingMsg) existingMsg.remove();

                const msg = document.createElement('div');
                msg.className = 'copied-message';
                msg.textContent = message;
                document.body.appendChild(msg);
                setTimeout(() => { msg.style.opacity = '1'; msg.style.bottom = '40px'; }, 10);
                setTimeout(() => {
                     msg.style.opacity = '0';
                     msg.addEventListener('transitionend', () => msg.remove());
                }, 2000);
            }

            function setupDragAndDrop(container) {
                let draggedPlantId = null;
                container.addEventListener('dragstart', e => {
                    if (e.target.classList.contains('project-plant-item')) {
                        draggedPlantId = e.target.dataset.plantId;
                        setTimeout(() => { e.target.style.opacity = '0.5'; }, 0);
                    }
                });
                container.addEventListener('dragend', e => {
                     if (e.target.classList.contains('project-plant-item')) {
                        e.target.style.opacity = '1';
                        draggedPlantId = null;
                     }
                });
                container.addEventListener('dragover', e => {
                    e.preventDefault();
                    const targetZone = e.target.closest('.zone');
                    if (targetZone) {
                       const currentlyOver = container.querySelector('.drag-over');
                       if(currentlyOver) currentlyOver.classList.remove('drag-over');
                       targetZone.classList.add('drag-over');
                    }
                });
                 container.addEventListener('dragleave', e => {
                    const targetZone = e.target.closest('.zone');
                    if (targetZone) { targetZone.classList.remove('drag-over'); }
                });
                container.addEventListener('drop', e => {
                    e.preventDefault();
                    const targetZoneEl = e.target.closest('.zone');
                    if (targetZoneEl) targetZoneEl.classList.remove('drag-over');
                    if (targetZoneEl && draggedPlantId) {
                        const targetZoneId = targetZoneEl.dataset.zoneId === 'null' ? null : parseInt(targetZoneEl.dataset.zoneId, 10);
                        movePlantToZone(draggedPlantId, targetZoneId);
                    }
                });
            }

            // --- MASTER EVENT LISTENER ---
            document.body.addEventListener('click', (e) => {
                if (e.target.id === 'chat-submit') aiSearch(chatInput.value);
                if (e.target.id === 'search-btn') searchPlants(searchInput.value);

                const targetId = e.target.id;
                const closestAction = e.target.closest('[data-action]');
                
                if(targetId === 'share-project-btn') generateShareUrl();
                if(targetId === 'save-project-btn') saveProjectToBackend();
                if(targetId === 'download-project-btn') downloadProjectAsCSV();
                if(targetId === 'visualizer-btn') {
                    const projectId = projectIdInput.value;
                    if (projectId) {
                        window.location.href = `/users/projects/${projectId}/visualizer`;
                    } else {
                        alert('No project loaded. Please select a project first.');
                    }
                }

                if (targetId === 'back-to-project-btn') {
                    selectedPlantId = null;
                    renderRightPane();
                    filterAndDisplayPlants();
                }

                 const projectPlantItem = e.target.closest('.project-plant-item');
                if (projectPlantItem && !e.target.closest('.remove-from-project-btn')) {
                    selectedPlantId = projectPlantItem.dataset.plantId;
                    renderRightPane();
                    const currentlySelected = document.querySelector('.plant-card.selected');
                    if(currentlySelected) currentlySelected.classList.remove('selected');
                    const newSelected = document.querySelector(`.plant-card[data-plant-id="${selectedPlantId}"]`);
                    if(newSelected) newSelected.classList.add('selected');
                }
                
                if (closestAction) {
                    const action = closestAction.dataset.action;
                    if (action === 'toggle-project') toggleProjectPlant(closestAction.dataset.plantId);
                    if (action === 'view-details') {
                        selectedPlantId = closestAction.dataset.plantId;
                        renderRightPane();
                        const currentlySelected = document.querySelector('.plant-card.selected');
                        if(currentlySelected) currentlySelected.classList.remove('selected');
                        const newSelected = document.querySelector(`.plant-card[data-plant-id="${selectedPlantId}"]`);
                        if(newSelected) newSelected.classList.add('selected');
                    }
                    if (action === 'add-zone') addZone();
                    if (action === 'expand-plot') openPlotModal();
                }

                if (closePlotModalBtn && e.target === closePlotModalBtn) closePlotModal();

                const deleteZoneBtn = e.target.closest('.delete-zone-btn');
                if (deleteZoneBtn) {
                    zoneToDeleteId = parseInt(deleteZoneBtn.dataset.zoneId, 10);
                    inlineConfirmModal.style.display = 'flex';
                }

                const editZoneBtn = e.target.closest('.edit-zone-btn');
                if (editZoneBtn) {
                    const zoneId = parseInt(editZoneBtn.dataset.zoneId, 10);
                    const titleContainer = editZoneBtn.closest('.zone-header').querySelector('.zone-title-container');
                    const currentTitle = titleContainer.querySelector('h4').textContent;
                    const input = document.createElement('input');
                    input.type = 'text'; input.value = currentTitle; input.className = 'zone-name-input';
                    const saveName = () => {
                        const newName = input.value.trim();
                        if (newName) {
                            const zone = projectData.zones.find(z => z.id === zoneId);
                            if (zone) zone.name = newName;
                        }
                        renderProject(projectZoneLeft); 
                        if (plotModal.style.display === 'flex') renderProject(modalPlotContainer, true);
                    };
                    input.addEventListener('blur', saveName);
                    input.addEventListener('keydown', (keyEvent) => {
                        if (keyEvent.key === 'Enter') saveName();
                        else if (keyEvent.key === 'Escape') {
                            renderProject(projectZoneLeft);
                            if (plotModal.style.display === 'flex') renderProject(modalPlotContainer, true);
                        }
                    });
                    titleContainer.innerHTML = '';
                    titleContainer.appendChild(input);
                    input.focus(); input.select();
                }

                const removeBtn = e.target.closest('.remove-from-project-btn');
                if (removeBtn) toggleProjectPlant(removeBtn.dataset.plantId);
            });
            
            plotModal.addEventListener('click', (e) => {
                if (e.target === plotModal) closePlotModal();
            });

            confirmDeleteBtn.addEventListener('click', confirmDeleteZone);
            cancelDeleteBtn.addEventListener('click', () => {
                inlineConfirmModal.style.display = 'none';
                zoneToDeleteId = null;
            });
            
            chatInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') aiSearch(chatInput.value) });
            searchInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') searchPlants(searchInput.value) });

            // --- INITIALIZE APP ---
            init();
        });
    </script>
</body>
</html>

