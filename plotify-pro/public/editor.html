<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plotify Pro Editor</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c6b4b;
            --secondary-color: #f4f7f6;
            --text-color: #333;
            --light-gray: #dde1e6;
            --white: #fff;
            --border-radius: 10px;
            --box-shadow: 0 2px 8px rgba(0, 0, 0, 0.07);
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: var(--secondary-color);
            color: var(--text-color);
            line-height: 1.6;
            overflow: hidden; /* Prevent body scroll */
        }

        .app-container {
            display: grid;
            grid-template-columns: 1fr 280px;
            grid-template-rows: 60px 1fr;
            height: 100vh;
            grid-template-areas:
                "header header"
                "canvas plants";
        }

        header {
            grid-area: header;
            background: var(--white);
            padding: 0 2rem;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--box-shadow);
            z-index: 10;
        }

        header .logo {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .pane {
            background-color: var(--white);
            height: calc(100vh - 60px);
            overflow-y: auto;
            border-right: 1px solid var(--light-gray);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
        }
        .pane:last-child {
            border-right: none;
        }
        
        /* Canvas Pane (Center) */
        .canvas-pane {
            grid-area: canvas;
            padding: 1.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            background-color: var(--secondary-color);
        }
        #editor-canvas {
            width: 100%;
            height: 100%;
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            border: 2px dashed var(--light-gray);
            cursor: default;
        }

        #canvas-placeholder {
            position: absolute;
            text-align: center;
            color: #888;
            pointer-events: none;
        }
        #canvas-placeholder-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Floating Action Buttons */
        #floating-actions {
            position: absolute;
            bottom: 2.5rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 1rem;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(5px);
            padding: 0.5rem 1rem;
            border-radius: 50px;
            box-shadow: var(--box-shadow);
            z-index: 5;
        }
        .float-btn {
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .float-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Inline Confirmation */
        #inline-confirm {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--white);
            padding: 1.5rem 2rem;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 20;
            text-align: center;
            transition: opacity 0.2s, transform 0.2s;
        }
        #inline-confirm.hidden {
            opacity: 0;
            transform: translate(-50%, -40%);
            pointer-events: none;
        }
        #inline-confirm p {
            margin-top: 0;
            margin-bottom: 1.5rem;
            font-weight: 500;
        }
        #inline-confirm button {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin: 0 0.5rem;
        }
        #confirm-yes-btn {
            background-color: #d32f2f;
            color: white;
        }
        #confirm-no-btn {
            background-color: var(--secondary-color);
            color: var(--text-color);
            border: 1px solid var(--light-gray);
        }

        /* Plants Pane (Right) */
        .plants-pane {
            grid-area: plants;
            transition: all 0.3s ease;
        }
        .plants-pane.disabled {
            filter: grayscale(100%);
            opacity: 0.6;
            pointer-events: none;
        }

        .plants-pane h3 {
            margin-top: 0;
            font-size: 1.2rem;
        }
        
        .zone-selector-container {
            margin-bottom: 1.5rem;
        }
        .zone-selector-container label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        #zone-selector {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            background-color: var(--white);
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
        }

        .plant-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 1rem;
        }

        .plant-item {
            background: var(--secondary-color);
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            padding: 0.5rem;
            text-align: center;
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .plant-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--box-shadow);
            border-color: var(--primary-color);
        }
        .plant-item:active {
            cursor: grabbing;
        }

        .plant-icon {
            font-size: 2.5rem;
            display: block;
            margin-bottom: 0.25rem;
        }

        .plant-name {
            font-size: 0.8rem;
            font-weight: 500;
            color: #555;
        }
        
        .hidden {
            display: none;
        }
        
        .tool-button.secondary {
            background-color: var(--white);
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
        }


        /* Responsive */
        @media (max-width: 900px) {
             .app-container {
                grid-template-columns: 1fr;
                grid-template-rows: 60px auto 1fr;
                height: auto;
                grid-template-areas:
                    "header"
                    "plants"
                    "canvas";
            }
            .pane {
                 height: auto;
                 border-right: none;
                 border-bottom: 1px solid var(--light-gray);
            }
             .canvas-pane {
                min-height: 400px;
            }
        }
    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <div class="logo">Plotify Pro Editor ü™¥</div>
            <a href="./project.html" class="tool-button secondary" style="width: auto; text-decoration: none;">Back to Planner</a>
        </header>

        <main class="pane canvas-pane">
            <input type="file" id="image-upload-input" accept="image/*" class="hidden">
            <div id="canvas-placeholder">
                <div id="canvas-placeholder-icon">üèûÔ∏è</div>
                <p>Upload a photo of your plot to begin</p>
            </div>
            <canvas id="editor-canvas"></canvas>
            <div id="floating-actions">
                <button id="upload-btn" class="float-btn" title="Upload Background Image">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                </button>
                <button id="download-btn" class="float-btn" title="Download Image">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                </button>
                <button id="clear-btn" class="float-btn" title="Clear Canvas">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                </button>
            </div>
            <div id="inline-confirm" class="hidden">
                <p>Are you sure you want to clear everything?</p>
                <button id="confirm-yes-btn">Yes, Clear</button>
                <button id="confirm-no-btn">No, Cancel</button>
            </div>
        </main>

        <aside class="pane plants-pane">
            <h3>Plant Library</h3>
             <div class="zone-selector-container">
                <label for="zone-selector">Select Zone</label>
                <select id="zone-selector"></select>
            </div>
            <ul id="plant-library" class="plant-list">
                <!-- Plant items will be injected here by JS -->
            </ul>
        </aside>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const canvas = document.getElementById('editor-canvas');
            const ctx = canvas.getContext('2d');
            const imageUploadInput = document.getElementById('image-upload-input');
            const uploadBtn = document.getElementById('upload-btn');
            const clearBtn = document.getElementById('clear-btn');
            const downloadBtn = document.getElementById('download-btn');
            const plantLibraryContainer = document.getElementById('plant-library');
            const plantsPane = document.querySelector('.plants-pane');
            const canvasPlaceholder = document.getElementById('canvas-placeholder');
            const inlineConfirm = document.getElementById('inline-confirm');
            const confirmYesBtn = document.getElementById('confirm-yes-btn');
            const confirmNoBtn = document.getElementById('confirm-no-btn');
            const zoneSelector = document.getElementById('zone-selector');

            // --- STATE ---
            let backgroundImage = null;
            let placedPlants = []; // {id, icon, name, x, y, size }
            let nextPlantId = 0;
            let hoveredPlantId = null;
            let selectedPlant = null;
            let isDragging = false;
            let offsetX = 0;
            let offsetY = 0;


            const plantData = {
                "project": {
                    "Flowers": [
                        { "name": "Rose", "icon": "üåπ" },
                        { "name": "Sunflower", "icon": "üåª" },
                        { "name": "Tulip", "icon": "üå∑" }
                    ],
                    "Trees": [
                        { "name": "Pine Tree", "icon": "üå≤" },
                        { "name": "Maple Tree", "icon": "üçÅ" },
                        { "name": "Evergreen", "icon": "üå≥" }
                    ],
                    "Desert": [
                        { "name": "Cactus", "icon": "üåµ" }
                    ],
                    "Other": [
                        { "name": "Lavender", "icon": "üåø" },
                        { "name": "Mushroom", "icon": "üçÑ" }
                    ]
                }
            };

            // --- INITIALIZATION ---
            function init() {
                setupCanvas();
                populateZoneSelector();
                const initialZone = Object.keys(plantData.project)[0];
                populatePlantsForZone(initialZone);
                setupEventListeners();
                updatePlantLibraryState();
            }

            function setupCanvas() {
                const container = canvas.parentElement;
                const dpi = window.devicePixelRatio || 1;
                canvas.width = container.clientWidth * dpi;
                canvas.height = container.clientHeight * dpi;
                canvas.style.width = `${container.clientWidth}px`;
                canvas.style.height = `${container.clientHeight}px`;
                ctx.scale(dpi, dpi);
            }
            
            function populateZoneSelector() {
                const zones = Object.keys(plantData.project);
                zoneSelector.innerHTML = zones.map(zone => `<option value="${zone}">${zone}</option>`).join('');
            }
            
            function populatePlantsForZone(zoneName) {
                const plants = plantData.project[zoneName] || [];
                plantLibraryContainer.innerHTML = '';
                plants.forEach(plant => {
                    const li = document.createElement('li');
                    li.className = 'plant-item';
                    li.draggable = true;
                    li.dataset.plantIcon = plant.icon;
                    li.dataset.plantName = plant.name;
                    li.innerHTML = `
                        <span class="plant-icon">${plant.icon}</span>
                        <span class="plant-name">${plant.name}</span>
                    `;
                    plantLibraryContainer.appendChild(li);
                });
            }
            
            function updatePlantLibraryState() {
                const plantItems = plantLibraryContainer.querySelectorAll('.plant-item');
                if (backgroundImage) {
                    plantsPane.classList.remove('disabled');
                    plantItems.forEach(item => item.draggable = true);
                } else {
                    plantsPane.classList.add('disabled');
                    plantItems.forEach(item => item.draggable = false);
                }
            }

            // --- CANVAS DRAWING ---
            function redrawCanvas() {
                const canvasWidth = canvas.width / (window.devicePixelRatio || 1);
                const canvasHeight = canvas.height / (window.devicePixelRatio || 1);
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (backgroundImage) {
                    canvas.style.border = '2px solid var(--primary-color)';
                    canvasPlaceholder.classList.add('hidden');
                    ctx.drawImage(backgroundImage, 0, 0, canvasWidth, canvasHeight);
                } else {
                    canvas.style.border = '2px dashed var(--light-gray)';
                    canvasPlaceholder.classList.remove('hidden');
                }

                placedPlants.forEach(plant => {
                    ctx.font = `${plant.size}px sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(plant.icon, plant.x, plant.y);

                    if (plant.id === hoveredPlantId) {
                        const deleteButtonRadius = 12;
                        const deleteButtonX = plant.x + plant.size / 2.5;
                        const deleteButtonY = plant.y - plant.size / 2.5;
                        
                        ctx.beginPath();
                        ctx.arc(deleteButtonX, deleteButtonY, deleteButtonRadius, 0, 2 * Math.PI);
                        ctx.fillStyle = 'rgba(211, 47, 47, 0.85)';
                        ctx.fill();

                        ctx.fillStyle = 'white';
                        ctx.font = `bold ${deleteButtonRadius * 1.2}px sans-serif`;
                        ctx.fillText('√ó', deleteButtonX, deleteButtonY + 1);
                    }
                });
            }

            // --- EVENT HANDLERS ---
            function handleImageUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            backgroundImage = img;
                            redrawCanvas();
                            updatePlantLibraryState();
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            }
            
            function handleDownload() {
                if (!backgroundImage) {
                    return; // Don't download if there's no base image
                }

                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                const dpi = window.devicePixelRatio || 1;

                // Set canvas size to match the original display size for a 1:1 download
                tempCanvas.width = canvas.clientWidth;
                tempCanvas.height = canvas.clientHeight;
                
                // We need to scale the drawing operations relative to the new canvas size
                const scaleX = tempCanvas.width / (canvas.width / dpi);
                const scaleY = tempCanvas.height / (canvas.height / dpi);

                // Draw background image
                tempCtx.drawImage(backgroundImage, 0, 0, tempCanvas.width, tempCanvas.height);

                // Draw each plant, adjusted for the new scale
                placedPlants.forEach(plant => {
                    const scaledX = plant.x * scaleX;
                    const scaledY = plant.y * scaleY;
                    const scaledSize = plant.size * Math.min(scaleX, scaleY);

                    tempCtx.font = `${scaledSize}px sans-serif`;
                    tempCtx.textAlign = 'center';
                    tempCtx.textBaseline = 'middle';
                    tempCtx.fillText(plant.icon, scaledX, scaledY);
                });

                // Create a link and trigger the download
                const link = document.createElement('a');
                link.download = 'plotify-design.png';
                link.href = tempCanvas.toDataURL('image/png');
                link.click();
            }


            function getPlantAtPosition(canvasX, canvasY) {
                for (let i = placedPlants.length - 1; i >= 0; i--) {
                    const plant = placedPlants[i];
                    const halfSize = plant.size / 2;
                    if (canvasX >= plant.x - halfSize && canvasX <= plant.x + halfSize &&
                        canvasY >= plant.y - halfSize && canvasY <= plant.y + halfSize) {
                        return plant;
                    }
                }
                return null;
            }
            
            function isClickOnDeleteButton(plant, clickX, clickY) {
                if (!plant) return false;
                const deleteButtonRadius = 12;
                const deleteButtonX = plant.x + plant.size / 2.5;
                const deleteButtonY = plant.y - plant.size / 2.5;
                
                const distance = Math.sqrt(Math.pow(clickX - deleteButtonX, 2) + Math.pow(clickY - deleteButtonY, 2));
                return distance <= deleteButtonRadius;
            }

            function handleMouseDown(event) {
                if (!backgroundImage) return;
                const rect = canvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;

                const plant = getPlantAtPosition(x, y);
                if (plant) {
                    selectedPlant = plant;
                    isDragging = false; 
                    offsetX = x - plant.x;
                    offsetY = y - plant.y;
                }
            }

            function handleMouseUp(event) {
                if (!isDragging) {
                    // It's a click, not the end of a drag.
                    const rect = canvas.getBoundingClientRect();
                    const x = event.clientX - rect.left;
                    const y = event.clientY - rect.top;

                    // Check if the click was on the delete button of the hovered plant
                    if (hoveredPlantId !== null) {
                        const plantToTest = placedPlants.find(p => p.id === hoveredPlantId);
                        if (isClickOnDeleteButton(plantToTest, x, y)) {
                            placedPlants = placedPlants.filter(p => p.id !== hoveredPlantId);
                            hoveredPlantId = null;
                            canvas.style.cursor = 'default';
                        }
                    }
                }
                // Always reset dragging state on mouseup
                isDragging = false;
                selectedPlant = null;
                
                // Redraw to reflect any changes
                redrawCanvas();
            }

            function handleMouseMove(event) {
                if (!backgroundImage) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;

                if (selectedPlant) {
                    isDragging = true;
                    selectedPlant.x = x - offsetX;
                    selectedPlant.y = y - offsetY;
                    canvas.style.cursor = 'grabbing';
                    if (hoveredPlantId !== null) {
                        hoveredPlantId = null;
                    }
                    redrawCanvas();
                    return; 
                }

                const plantOver = getPlantAtPosition(x, y);
                const newHoveredId = plantOver ? plantOver.id : null;
                
                canvas.style.cursor = newHoveredId !== null ? 'pointer' : 'default';
                
                if (newHoveredId !== hoveredPlantId) {
                    hoveredPlantId = newHoveredId;
                    redrawCanvas();
                }
            }

            function handleDragStart(event) {
                if (event.target.classList.contains('plant-item')) {
                    event.dataTransfer.setData('text/plain', JSON.stringify({
                        icon: event.target.dataset.plantIcon,
                        name: event.target.dataset.plantName
                    }));
                    event.dataTransfer.effectAllowed = 'copy';
                }
            }

            function handleDragOver(event) {
                event.preventDefault();
                event.dataTransfer.dropEffect = 'copy';
            }

            function handleDrop(event) {
                event.preventDefault();
                const data = JSON.parse(event.dataTransfer.getData('text/plain'));
                
                const rect = canvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;

                placedPlants.push({
                    id: nextPlantId++,
                    icon: data.icon,
                    name: data.name,
                    x: x,
                    y: y,
                    size: 40
                });

                redrawCanvas();
            }

            function showClearConfirmation() {
                inlineConfirm.classList.remove('hidden');
            }
            
            function performClear() {
                placedPlants = [];
                backgroundImage = null;
                hoveredPlantId = null;
                redrawCanvas();
                updatePlantLibraryState();
                inlineConfirm.classList.add('hidden');
            }

            // --- EVENT LISTENERS ---
            function setupEventListeners() {
                window.addEventListener('resize', () => {
                    setupCanvas();
                    redrawCanvas();
                });

                uploadBtn.addEventListener('click', () => imageUploadInput.click());
                imageUploadInput.addEventListener('change', handleImageUpload);
                clearBtn.addEventListener('click', showClearConfirmation);
                downloadBtn.addEventListener('click', handleDownload);
                
                confirmYesBtn.addEventListener('click', performClear);
                confirmNoBtn.addEventListener('click', () => inlineConfirm.classList.add('hidden'));
                
                zoneSelector.addEventListener('change', (e) => populatePlantsForZone(e.target.value));

                canvas.addEventListener('mousedown', handleMouseDown);
                canvas.addEventListener('mouseup', handleMouseUp);
                canvas.addEventListener('mousemove', handleMouseMove);
                
                canvas.addEventListener('mouseleave', () => {
                    if (hoveredPlantId !== null) {
                        hoveredPlantId = null;
                        redrawCanvas();
                        canvas.style.cursor = 'default';
                    }
                    selectedPlant = null;
                    isDragging = false;
                });
                
                plantLibraryContainer.addEventListener('dragstart', handleDragStart);
                canvas.addEventListener('dragover', handleDragOver);
                canvas.addEventListener('drop', handleDrop);
            }

            // --- START THE APP ---
            init();
        });
    </script>
</body>
</html>

