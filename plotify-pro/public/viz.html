<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Image Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple spinner animation */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
     <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl bg-gray-800 rounded-2xl shadow-lg p-6 md:p-8">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-cyan-400">Gemini Image Editor</h1>
            <p class="text-gray-400 mt-2">Edit an image using a text prompt with the "Nano Banana" model.</p>
        </header>

        <!-- Configuration Section -->
        <div class="mb-6">
            <label for="imageFile" class="block text-sm font-medium text-gray-300 mb-2">Upload Image</label>
            <input type="file" id="imageFile" accept="image/png, image/jpeg" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-cyan-600 file:text-white hover:file:bg-cyan-700 cursor-pointer">
        </div>

        <div class="text-center mb-6">
            <button id="editButton" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-6 rounded-lg transition-colors duration-300 inline-flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path><path d="M5 3v4"></path><path d="M19 17v4"></path><path d="M3 5h4"></path><path d="M17 19h4"></path></svg>
                Edit Image
            </button>
        </div>

        <!-- Image Display -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
                <h3 class="text-lg font-semibold text-center mb-2 text-gray-400">Original</h3>
                <div class="bg-gray-700/50 rounded-lg aspect-square flex items-center justify-center">
                    <img id="originalImage" src="https://placehold.co/512x512/374151/9CA3AF?text=Upload+an+Image" alt="Original" class="max-w-full max-h-full rounded-lg object-contain">
                </div>
            </div>
            <div>
                <h3 class="text-lg font-semibold text-center mb-2 text-gray-400">Edited</h3>
                <div id="editedImageContainer" class="bg-gray-700/50 rounded-lg aspect-square flex items-center justify-center relative">
                    <img id="editedImage" src="https://placehold.co/512x512/374151/9CA3AF?text=Result+Appears+Here" alt="Edited" class="max-w-full max-h-full rounded-lg object-contain">
                    <div id="spinner" class="spinner absolute hidden"></div>
                </div>
            </div>
        </div>
        
        <!-- Status Log -->
        <div>
             <h3 class="text-lg font-semibold mb-2 text-gray-400">Status Log</h3>
             <div class="bg-gray-900/80 rounded-lg p-4 h-40 overflow-y-auto">
                <pre id="statusLog" class="text-sm text-gray-300 whitespace-pre-wrap"></pre>
             </div>
        </div>
    </div>

    <script type="module">
        // --- Configuration ---
        // IMPORTANT: Add your Google AI API Key here.
        const API_KEY = "AIzaSyDGJ0UGAIBbTqWRC5YnGnbYrrfiOyhSVKU"; // <-- PASTE YOUR API KEY HERE
        const PROMPT_TYPE_VALIDATE = "validate";
        const PROMPT_TYPE_SKETCH = "sketch";


        // --- Element References ---
        const imageFileInput = document.getElementById('imageFile');
        const editButton = document.getElementById('editButton');
        const originalImage = document.getElementById('originalImage');
        const editedImage = document.getElementById('editedImage');
        const spinner = document.getElementById('spinner');
        const statusLog = document.getElementById('statusLog');
        
        const modelName = "gemini-2.5-flash-image-preview";

        // --- Utility Functions ---

        /**
         * Logs a message to the status box on the UI.
         * @param {string} message The message to log.
         * @param {string} type 'info', 'error', or 'success'.
         */
        function log(message, type = 'info') {
            const colorMap = {
                info: 'text-gray-300',
                error: 'text-red-400',
                success: 'text-green-400'
            };
            const date = new Date().toLocaleTimeString();
            statusLog.innerHTML += `<span class="${colorMap[type]}">[${date}] ${message}\n</span>`;
            statusLog.scrollTop = statusLog.scrollHeight; // Auto-scroll
        }
        
        /**
         * Converts a File object to a base64 string.
         * @param {File} file The file to convert.
         * @returns {Promise<string>} A promise that resolves with the base64 data.
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
        
        /**
         * Fetches a prompt from a local API endpoint.
         * @param {string} promptType The type of prompt to fetch (e.g., 'validate', 'sketch').
         * @returns {Promise<string>} The fetched prompt text.
         */
        async function fetchPrompt(promptType) {
            log(`Fetching prompt for type: '${promptType}'...`, 'info');
            const promptApiUrl = `http://localhost:3000/api/visualizer/${promptType}`;
            const response = await fetch(promptApiUrl);
            if (!response.ok) {
                throw new Error(`Failed to fetch prompt '${promptType}'. Status: ${response.status}`);
            }
            const data = await response.json();
            const prompt = data.prompt;
            if (!prompt) {
                throw new Error(`The key 'prompt' was not found for type '${promptType}'.`);
            }
            log(`Successfully fetched prompt: "${prompt}"`, 'info');
            return prompt;
        }

        // --- Event Listeners ---

        imageFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                originalImage.src = URL.createObjectURL(file);
                log('Image loaded successfully.', 'info');
            }
        });

        editButton.addEventListener('click', async () => {
            const file = imageFileInput.files[0];

            // --- Initial Validation ---
            if (!API_KEY) {
                log('API Key is missing. Please add it to the script.', 'error');
                alert('API Key is missing. Please edit the HTML file to add your key.');
                return;
            }
            if (!file) {
                log('No image file selected.', 'error');
                alert('Please select an image file to edit.');
                return;
            }

            // --- Start Process ---
            log('Starting multi-step image editing process...', 'info');
            spinner.classList.remove('hidden');
            editButton.disabled = true;
            editButton.classList.add('opacity-50', 'cursor-not-allowed');
            editedImage.src = 'https://placehold.co/512x512/374151/9CA3AF?text=Processing...';

            try {
                const base64DataUrl = await fileToBase64(file);
                const base64Data = base64DataUrl.split(',')[1];
                const mimeType = file.type;
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${API_KEY}`;

                // --- STEP 1: VALIDATE THE IMAGE ---
                log("--- Step 1: Validating Image ---", "info");
                const validationPrompt = await fetchPrompt(PROMPT_TYPE_VALIDATE);
                const validationPayload = {
                    contents: [{ parts: [{ text: validationPrompt }, { inlineData: { mimeType, data: base64Data } }] }]
                };
                
                const validationResponse = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(validationPayload)
                });

                if (!validationResponse.ok) {
                    const errorData = await validationResponse.json();
                    throw new Error(`Validation API Error (${validationResponse.status}): ${errorData.error?.message || 'Unknown error'}`);
                }
                
                const validationResult = await validationResponse.json();
                const validationText = validationResult.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!validationText || validationText.trim().toLowerCase() !== 'yes') {
                    throw new Error(`Image validation failed. The model responded: "${validationText || 'No response'}". Please upload a different image.`);
                }
                log("Image validation successful!", "success");

                // --- STEP 2: SKETCH THE IMAGE ---
                log("--- Step 2: Applying Sketch Effect ---", "info");
                const sketchPrompt = await fetchPrompt(PROMPT_TYPE_SKETCH);
                const sketchPayload = {
                    contents: [{ parts: [{ text: sketchPrompt }, { inlineData: { mimeType, data: base64Data } }] }]
                };

                const sketchResponse = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(sketchPayload)
                });
                
                if (!sketchResponse.ok) {
                    const errorData = await sketchResponse.json();
                    throw new Error(`Sketch API Error (${sketchResponse.status}): ${errorData.error?.message || 'Unknown error'}`);
                }

                const sketchResult = await sketchResponse.json();
                const imageDataPart = sketchResult.candidates?.[0]?.content?.parts?.find(p => p.inlineData);

                if (!imageDataPart) {
                    const textPart = sketchResult.candidates?.[0]?.content?.parts?.[0]?.text;
                     if (textPart) {
                        throw new Error(`Sketch model responded with text: "${textPart.text}"`);
                    }
                     const finishReason = sketchResult.candidates?.[0]?.finishReason;
                    if(finishReason && finishReason !== 'STOP') {
                         throw new Error(`Sketch request terminated. Reason: ${finishReason}`);
                    }
                    throw new Error('No image data found in the sketch API response.');
                }

                editedImage.src = `data:image/png;base64,${imageDataPart.inlineData.data}`;
                log('Image successfully sketched!', 'success');

            } catch (error) {
                log(error.message, 'error');
                editedImage.src = 'https://placehold.co/512x512/374151/9CA3AF?text=Error+Occurred';
                // If validation failed, clear the input
                if (error.message.includes("validation failed")) {
                    imageFileInput.value = null; // Clear the file input
                    originalImage.src = 'https://placehold.co/512x512/374151/9CA3AF?text=Upload+an+Image';
                    alert(error.message);
                }
            } finally {
                spinner.classList.add('hidden');
                editButton.disabled = false;
                editButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });

        log('Application initialized. Please add your API key to the script and select an image.');
    </script>
</body>
</html>

