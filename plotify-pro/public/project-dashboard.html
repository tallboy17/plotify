<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plotify - Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Design System Variables from project.html */
        :root {
            --primary-color: #2c6b4b;
            --secondary-color: #f4f7f6;
            --text-color: #333;
            --light-gray: #dde1e6;
            --white: #fff;
            --danger-color: #c62828;
            --danger-bg: #fff0f0;
            --cta-blue: #4285F4; /* New blue for the main CTA button */
            --border-radius: 10px;
            --box-shadow: 0 2px 8px rgba(0, 0, 0, 0.07);
            --status-completed-bg: #e8f5e9;
            --status-completed-text: #2e7d32;
            --status-inprogress-bg: #e3f2fd;
            --status-inprogress-text: #1565c0;
        }

        /* Base Body Styles */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: var(--secondary-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        /* Header from project.html - Modified */
        header {
            background: var(--white);
            padding: 0 2rem;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--box-shadow);
            height: 60px;
            position: relative; /* For progress bar positioning */
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .logo-icon {
            font-size: 1.6rem;
        }
        .logo-text {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .header-divider {
            border-left: 1px solid var(--light-gray);
            height: 24px;
        }

        .header-title {
            font-size: 1.2rem;
            font-weight: 500;
            color: #555;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        /* Progress Bar */
        .progress-bar-container {
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: transparent;
            overflow: hidden;
            visibility: hidden;
            z-index: 11;
        }

        .progress-bar {
            width: 40%;
            height: 100%;
            background-color: var(--primary-color);
            animation: progressBarAnimation 1.5s ease-in-out infinite;
        }

        @keyframes progressBarAnimation {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(350%);
            }
        }

        /* Main Projects Container */
        .projects-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Projects Header (Title and New Project Button) - REMOVED */

        /* Main Button Styles */
        .btn {
            padding: 0.6rem 1.2rem; /* Adjusted padding */
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem; /* Adjusted font size */
            font-weight: 600;
            transition: background-color 0.2s, transform 0.2s;
            text-decoration: none; /* Removed underline from links styled as buttons */
        }

        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-cta {
            background-color: var(--cta-blue);
            color: var(--white);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.25);
        }
        .btn-cta:hover {
             background-color: #3367D6;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: var(--white);
            box-shadow: 0 4px 12px rgba(44, 107, 75, 0.2);
        }
        .btn-primary:hover {
            background-color: #1e4d2e;
        }

        .btn-secondary {
            background-color: var(--white);
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }
        .btn-secondary:hover {
            background-color: var(--secondary-color);
        }

        .btn-danger {
            background-color: var(--white);
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
        }
        .btn-danger:hover {
            background-color: var(--danger-bg);
        }

        /* Filter Buttons */
        .project-filters {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 2rem;
        }

        .filter-btn {
            background-color: var(--white);
            color: var(--text-color);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            border: 1px solid var(--light-gray);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            background-color: #e8e8e8;
            border-color: #ccc;
        }

        .filter-btn.active {
            background-color: var(--primary-color);
            color: var(--white);
            border-color: var(--primary-color);
        }

        /* Grid for Project Cards */
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }

        /* Project Card Styling */
        .project-card {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid var(--light-gray);
            color: var(--text-color);
            position: relative; /* Needed for positioning the delete button */
        }

        .project-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.1);
        }

        .card-delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.5rem;
            line-height: 1;
            color: #ccc;
            cursor: pointer;
            padding: 0.25rem;
            transition: color 0.2s;
            z-index: 10;
        }
        .card-delete-btn:hover {
            color: var(--danger-color);
        }

        .project-card-title {
            margin: 0 0 0.5rem 0;
            font-size: 1.3rem;
            color: var(--primary-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .project-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .project-card-header-main {
            flex-grow: 1;
        }

        .project-card-status {
            padding: 0.2rem 0.6rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .status-in-progress {
            background-color: var(--status-inprogress-bg);
            color: var(--status-inprogress-text);
        }
        .status-completed {
            background-color: var(--status-completed-bg);
            color: var(--status-completed-text);
        }
        
        .project-card-client {
            margin: 0;
            font-size: 0.9rem;
            font-weight: 500;
            color: #555;
            min-height: 22px; /* Reserve space */
        }

        .project-card-description {
            margin: 0;
            font-size: 0.9rem;
            color: #555;
            flex-grow: 1; /* Pushes footer down */
        }
        
        /* Inline Edit Styles */
        .inline-edit-input, .inline-edit-textarea {
            width: 100%;
            padding: 0.25rem 0.5rem;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-family: 'Inter', sans-serif;
            background-color: #f9f9f9;
        }
        .inline-edit-input {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        .inline-edit-input.client-input {
            font-size: 0.9rem;
            font-weight: 500;
            color: #555;
        }
        .inline-edit-textarea {
            font-size: 0.9rem;
            color: #555;
            resize: vertical;
            min-height: 80px;
        }

        .inline-edit-input.input-error, 
        .inline-edit-textarea.input-error {
            border: 1px solid var(--danger-color);
            background-color: var(--danger-bg);
        }

        .project-card-meta-edit {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            font-size: 0.8rem;
            color: #777;
        }
        .project-card-meta-edit div {
            flex: 1;
        }
        .project-card-meta-edit label {
            display: block;
            margin-bottom: 0.25rem;
        }
        .inline-edit-date {
            font-size: 0.9rem;
            color: #555;
            box-sizing: border-box;
            height: 30px;
            width: 100%;
        }
        
        .project-card-dates {
            font-size: 0.8rem;
            color: #777;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--secondary-color);
        }
        
        .project-card-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            font-size: 0.85rem;
            color: #666;
            padding-top: 0.5rem;
        }
        .stats-info {
            display: flex;
            gap: 1rem;
        }
        .delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            color: #aaa;
            padding: 0.2rem;
        }
        .delete-btn:hover { color: var(--danger-color); }
        .delete-confirmation {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            width: 100%;
            justify-content: flex-end;
        }
        .confirm-delete-btn {
            background-color: var(--danger-bg);
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
            padding: 0.2rem 0.5rem;
            border-radius: 5px;
            cursor: pointer;
        }
        .cancel-delete-btn {
            background: var(--white);
            border: 1px solid #ccc;
            padding: 0.2rem 0.5rem;
            border-radius: 5px;
            cursor: pointer;
        }

        .project-card-footer {
            margin-top: auto; /* Aligns to bottom */
            padding-top: 0.5rem;
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .project-card-footer .btn {
            flex: 1;
            text-align: center;
        }
        
        /* Toggle Switch Styles */
        .status-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: #555;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 20px;
        }

        .switch input { opacity: 0; width: 0; height: 0; }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--status-inprogress-bg);
            border: 1px solid var(--status-inprogress-text);
            transition: .4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 12px;
            width: 12px;
            left: 3px;
            bottom: 3px;
            background-color: var(--status-inprogress-text);
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--status-completed-bg);
            border-color: var(--status-completed-text);
        }

        input:checked + .slider:before {
            background-color: var(--status-completed-text);
            transform: translateX(14px);
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .projects-container { padding: 1rem; }
            header { padding: 0 1rem; }
            .header-title { display: none; } /* Hide title on smaller screens */
        }

    </style>
</head>
<body>

    <header>
        <div class="header-left">
            <div class="logo-container">
                <span class="logo-icon">ðŸª´</span>
                <span class="logo-text">Plotify Pro</span>
            </div>
            <div class="header-divider"></div>
            <div class="header-title">Dashboard</div>
        </div>
        <div class="header-actions">
            <button class="btn btn-cta" id="new-project-btn">+ New Project</button>
            <button class="btn btn-secondary" id="logout-btn">Logout</button>
        </div>
        <div class="progress-bar-container">
            <div class="progress-bar"></div>
        </div>
    </header>

    <main class="projects-container">
        <div class="project-filters">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="in-progress">In Progress</button>
            <button class="filter-btn" data-filter="completed">Completed</button>
        </div>

        <div class="projects-grid" id="projects-grid">
            <!-- Project cards will be dynamically inserted here by JavaScript -->
        </div>
    </main>
        <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION ---
            const useMock = false; // Set to false to use the backend API
            const API_ENDPOINT = '/api/users/projects';

            // --- DOM ELEMENTS ---
            const projectsGrid = document.getElementById('projects-grid');
            const filterContainer = document.querySelector('.project-filters');
            const newProjectBtn = document.getElementById('new-project-btn');
            const progressBarContainer = document.querySelector('.progress-bar-container');

            // --- APP STATE ---
            let projects = [];
            let projectToDeleteId = null;
            let editingProjectId = null;
            
            const initialMockProjects = [
                {
                    "user_id": "68c492f0d0ea881f407bf5dc",
                    "project_id": "proj_1",
                    "project_name": "Backyard Oasis Renovation",
                    "status": "in-progress",
                    "description": "A complete overhaul of the backyard with a new patio area and drought-tolerant plants.",
                    "client": "The Johnson Family",
                    "startDate": "2025-08-15",
                    "completedDate": null,
                    "projectData": { "plants": { "p1": {}, "p2": {} }, "zones": [ { "id": 1, "name": "Patio" } ] }
                },
                {
                    "user_id": "68c492f0d0ea881f407bf5dc",
                    "project_id": "proj_2",
                    "project_name": "Front Yard Redesign",
                    "status": "completed",
                    "description": "Replaced the front lawn with native flowers and shrubs to attract pollinators.",
                    "client": null,
                    "startDate": "2025-06-01",
                    "completedDate": "2025-07-20",
                    "projectData": { "plants": { "p1": {}, "p2": {}, "p3": {} }, "zones": [ { "id": 1, "name": "Flower Bed" }, { "id": 2, "name": "Shrubbery" } ] }
                },
                {
                    "user_id": "68c492f0d0ea881f407bf5dc",
                    "project_id": "proj_3",
                    "project_name": "Community Garden Plot",
                    "status": "in-progress",
                    "description": "Setting up a raised bed for vegetables and herbs for the summer season.",
                    "client": null,
                    "startDate": "2025-09-01",
                    "completedDate": null,
                    "projectData": { "plants": { "p1": {}, "p2": {} }, "zones": [ { "id": 1, "name": "Veggie Patch" } ] }
                }
            ];

            // --- AUTH OBJECT ---
            const authObject = {
                userId: null,
                token: null,
                isAuthenticated: false,
                
                // Initialize from localStorage
                init() {
                    const storedToken = localStorage.getItem('jwt_token');
                    const storedUserId = localStorage.getItem('user_id');
                    
                    if (storedToken && storedUserId) {
                        this.token = storedToken;
                        this.userId = storedUserId;
                        this.isAuthenticated = true;
                        console.log('Auth initialized from localStorage:', { userId: this.userId, hasToken: !!this.token });
                    } else {
                        console.warn('No authentication data found in localStorage');
                        this.clearStoredAuth();
                    }
                },
                
                // Login function - redirects to main page for Google OAuth
                async login() {
                    console.log('No valid authentication found, redirecting to login page');
                    window.location.href = '/index.html';
                    return false;
                },
                
                // Get auth headers
                getAuthHeaders: function() {
                    if (!this.isAuthenticated || !this.token) {
                        throw new Error('Not authenticated. Please login first.');
                    }
                    return {
                        'Authorization': `Bearer ${this.token}`,
                        'Content-Type': 'application/json'
                    };
                },
                
                // Check if token is valid and not expired
                isTokenValid: function() {
                    if (!this.token) return false;
                    
                    try {
                        // Decode JWT token to check expiry
                        const payload = JSON.parse(atob(this.token.split('.')[1]));
                        const currentTime = Math.floor(Date.now() / 1000);
                        
                        if (payload.exp && payload.exp < currentTime) {
                            console.log('Token has expired, clearing localStorage');
                            this.clearStoredAuth();
                            return false;
                        }
                        
                        return this.isAuthenticated && this.token.length > 0;
                    } catch (error) {
                        console.error('Error validating token:', error);
                        this.clearStoredAuth();
                        return false;
                    }
                },
                
                // Clear stored authentication data
                clearStoredAuth: function() {
                    localStorage.removeItem('jwt_token');
                    localStorage.removeItem('user_id');
                    this.token = null;
                    this.isAuthenticated = false;
                }
            };

            // --- API & DATA FUNCTIONS ---
            async function fetchProjects() {
                progressBarContainer.style.visibility = 'visible';
                try {
                    if (useMock) {
                        console.log("Using mock data.");
                        await new Promise(resolve => setTimeout(resolve, 800)); // Simulate network delay
                        return initialMockProjects;
                    }
                    
                    // Ensure user is authenticated
                    if (!authObject.isTokenValid()) {
                        console.log('Token invalid or expired, redirecting to login');
                        window.location.href = '/index.html';
                        return [];
                    }
                    
                    console.log(`Fetching projects for user: ${authObject.userId}`);
                    const response = await fetch(API_ENDPOINT, { headers: authObject.getAuthHeaders() });

                    if (!response.ok) {
                        if (response.status === 401) {
                            console.log('Unauthorized access, redirecting to login');
                            window.location.href = '/index.html';
                            return [];
                        }
                        throw new Error(`API request failed with status ${response.status}`);
                    }
                    
                    return await response.json();

                } catch (error) {
                    console.error("Failed to fetch projects from API:", error);
                    projectsGrid.insertAdjacentHTML('beforebegin', '<p style="color: red;">Could not load projects. Displaying sample data.</p>');
                    return initialMockProjects;
                } finally {
                    progressBarContainer.style.visibility = 'hidden';
                }
            }
            
            async function createProject(projectToCreate) {
                const card = document.querySelector(`.project-card[data-project-id="${projectToCreate.project_id}"]`);
                const saveButton = card ? card.querySelector('.save-btn') : null;

                if (saveButton) {
                    saveButton.disabled = true;
                    saveButton.textContent = 'Saving...';
                }

                try {
                    if (useMock) {
                        console.log("Mock Create: New project would be sent to the backend.", projectToCreate);
                        await new Promise(resolve => setTimeout(resolve, 500));
                        const newProjectFromServer = { ...projectToCreate, project_id: `server_id_${Date.now()}` };
                        return newProjectFromServer;
                    }

                    if (!authObject.isTokenValid()) {
                        console.log('Token invalid or expired, redirecting to login');
                        window.location.href = '/index.html';
                        return null;
                    }

                    const payload = { ...projectToCreate };
                    delete payload.project_id; // Backend will assign the ID

                    const response = await fetch(`/users/projects`, {
                        method: 'POST',
                        headers: authObject.getAuthHeaders(),
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.text();
                        throw new Error(`API error! status: ${response.status}. Message: ${errorData}`);
                    }

                    console.log('Project created successfully');
                    return await response.json(); // Return the newly created project from the server

                } catch (error) {
                    console.error('Failed to create project:', error);
                    alert('Error creating project. Please try again.');
                    return null;
                } finally {
                    if (saveButton) {
                        saveButton.disabled = false;
                        saveButton.textContent = 'Save';
                    }
                }
            }
            
            async function saveProject(projectToSave) {
                const card = document.querySelector(`.project-card[data-project-id="${projectToSave.project_id}"]`);
                const saveButton = card ? card.querySelector('.save-btn') : null;
                
                if(saveButton) {
                    saveButton.disabled = true;
                    saveButton.textContent = 'Saving...';
                }

                try {
                    if (useMock) {
                        console.log("Mock Save: Project data would be sent to the backend.", projectToSave);
                        await new Promise(resolve => setTimeout(resolve, 500)); // Simulate network delay
                        return true;
                    }

                    if (!authObject.isTokenValid()) {
                        console.log('Token invalid or expired, redirecting to login');
                        window.location.href = '/index.html';
                        return false;
                    }
                    
                    const response = await fetch(`/users/projects/${projectToSave.project_id}`, {
                        method: 'PUT',
                        headers: authObject.getAuthHeaders(),
                        body: JSON.stringify(projectToSave)
                    });

                    if (!response.ok) {
                        const errorData = await response.text();
                        throw new Error(`API error! status: ${response.status}. Message: ${errorData}`);
                    }
                    
                    console.log('Project saved successfully');
                    return true;

                } catch (error) {
                    console.error('Failed to save project:', error);
                    alert('Error saving project. Please try again.'); 
                    return false;
                } finally {
                     if(saveButton) {
                        saveButton.disabled = false;
                        saveButton.textContent = 'Save';
                    }
                }
            }

            async function deleteProject(projectId) {
                try {
                    if (useMock) {
                        console.log(`Mock Delete: Project with id ${projectId} would be deleted.`);
                        await new Promise(resolve => setTimeout(resolve, 500));
                        return true;
                    }

                    if (!authObject.isTokenValid()) {
                        console.log('Token invalid or expired, redirecting to login');
                        window.location.href = '/index.html';
                        return false;
                    }

                    const response = await fetch(`/users/projects/${projectId}`, {
                        method: 'DELETE',
                        headers: authObject.getAuthHeaders()
                    });

                    if (!response.ok) {
                        const errorData = await response.text();
                        throw new Error(`API error! status: ${response.status}. Message: ${errorData}`);
                    }

                    console.log('Project deleted successfully');
                    return true;

                } catch (error) {
                    console.error('Failed to delete project:', error);
                    alert('Error deleting project. Please try again.');
                    return false;
                }
            }
            
            // --- UTILITY FUNCTIONS ---
            const formatDate = (dateString) => {
                if (!dateString) return '';
                const date = new Date(dateString);
                const userTimezoneOffset = date.getTimezoneOffset() * 60000;
                return new Date(date.getTime() + userTimezoneOffset).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            };

            // --- RENDER FUNCTION ---
            const renderProjects = () => {
                const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;
                projectsGrid.innerHTML = '';

                const filteredProjects = projects.filter(p => activeFilter === 'all' || p.status === activeFilter);
                
                if (filteredProjects.length === 0) {
                    projectsGrid.innerHTML = '<p>No projects found for this filter.</p>';
                    return;
                }

                filteredProjects.forEach(project => {
                    const card = document.createElement('div');
                    card.className = 'project-card';
                    card.dataset.projectId = project.project_id;
                    
                    const plantCount = project.projectData?.plants ? Object.keys(project.projectData.plants).length : 0;
                    const zoneCount = project.projectData?.zones ? project.projectData.zones.length : 0;

                    if (editingProjectId === project.project_id) {
                        card.innerHTML = `
                            <input type="text" class="inline-edit-input" value="${project.project_name}" data-field="projectName" placeholder="Project Name (Required)">
                            <div class="project-card-header">
                                <div class="project-card-header-main">
                                    <input type="text" class="inline-edit-input client-input" placeholder="Client Name (Optional)" value="${project.client || ''}" data-field="client">
                                </div>
                            </div>
                            <textarea class="inline-edit-textarea" data-field="description" placeholder="Project Description (Required)">${project.description}</textarea>
                            <div class="project-card-meta-edit">
                                <div>
                                    <label>Status</label>
                                    <div class="status-toggle" style="padding-top: 5px;">
                                        <label class="switch">
                                            <input type="checkbox" data-field="status" ${project.status === 'completed' ? 'checked' : ''}>
                                            <span class="slider"></span>
                                        </label>
                                        <span class="status-text-edit" style="margin-left: 10px;">${project.status === 'completed' ? 'Completed' : 'In Progress'}</span>
                                    </div>
                                </div>
                                <div></div>
                                <div>
                                    <label for="startDate-${project.project_id}">Started</label>
                                    <input type="date" id="startDate-${project.project_id}" class="inline-edit-date" value="${project.startDate || ''}" data-field="startDate">
                                </div>
                                <div>
                                    <label for="completedDate-${project.project_id}">Completed</label>
                                    <input type="date" id="completedDate-${project.project_id}" class="inline-edit-date" value="${project.completedDate || ''}" data-field="completedDate">
                                </div>
                            </div>
                            <div class="project-card-stats">
                               <div class="stats-info">
                                    <span>ðŸŒ³ ${plantCount} Plants</span>
                                    <span>ðŸŒ¿ ${zoneCount} Zones</span>
                                </div>
                            </div>
                            <div class="project-card-footer">
                                <button class="btn btn-primary save-btn" data-project-id="${project.project_id}">Save</button>
                                <button class="btn btn-secondary cancel-edit-btn">Cancel</button>
                            </div>
                        `;
                    } else {
                        const statusText = project.status === 'in-progress' ? 'In Progress' : 'Completed';
                        let footerContent = (projectToDeleteId === project.project_id) ? `
                            <div class="delete-confirmation">
                                <span>Delete project?</span>
                                <button class="cancel-delete-btn">No</button>
                                <button class="confirm-delete-btn" data-project-id="${project.project_id}">Yes, Delete</button>
                            </div>` : `
                            <a href="/users/projects/${project.project_id}" class="btn btn-primary">View</a>
                            <button class="btn btn-secondary edit-btn" data-project-id="${project.project_id}">Edit</button>
                        `;

                        card.innerHTML = `
                            ${projectToDeleteId !== project.project_id ? `<button class="card-delete-btn" data-project-id="${project.project_id}" title="Delete project">&times;</button>` : ''}
                            <h2 class="project-card-title" title="${project.project_name}">${project.project_name}</h2>
                            <div class="project-card-header">
                                <div class="project-card-header-main">
                                    ${project.client ? `<p class="project-card-client">Client: ${project.client}</p>` : '<p class="project-card-client">&nbsp;</p>'}
                                </div>
                                <span class="project-card-status status-${project.status}">${statusText}</span>
                            </div>
                            <p class="project-card-description">${project.description}</p>
                            <div class="project-card-dates">
                                <span>Started: ${formatDate(project.startDate)}</span>
                                ${project.completedDate ? `<span>Completed: ${formatDate(project.completedDate)}</span>` : ''}
                            </div>
                            <div class="project-card-stats">
                               <div class="stats-info">
                                    <span>ðŸŒ³ ${plantCount} Plants</span>
                                    <span>ðŸŒ¿ ${zoneCount} Zones</span>
                                </div>
                            </div>
                            <div class="project-card-footer">${footerContent}</div>
                        `;
                    }
                    projectsGrid.appendChild(card);
                });
            };

            // --- EVENT LISTENERS ---
            filterContainer.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    document.querySelector('.filter-btn.active').classList.remove('active');
                    e.target.classList.add('active');
                    projectToDeleteId = null;
                    editingProjectId = null;
                    renderProjects();
                }
            });

            newProjectBtn.addEventListener('click', () => {
                const newId = `proj_${Date.now()}`;
                const newProject = {
                    project_id: newId,
                    project_name: "",
                    status: "in-progress",
                    description: "",
                    client: null,
                    startDate: new Date().toISOString().split('T')[0],
                    completedDate: null,
                    projectData: { plants: {}, zones: [] }
                };
                projects.unshift(newProject);
                document.querySelector('.filter-btn.active').classList.remove('active');
                document.querySelector('[data-filter="all"]').classList.add('active');
                projectToDeleteId = null;
                editingProjectId = newId;
                renderProjects();
            });

            projectsGrid.addEventListener('click', async (e) => {
                const target = e.target;
                const projectId = target.closest('.project-card')?.dataset.projectId;

                if (target.closest('.edit-btn')) {
                    editingProjectId = projectId;
                    projectToDeleteId = null;
                    renderProjects();
                } else if (target.closest('.card-delete-btn')) {
                    projectToDeleteId = projectId;
                    editingProjectId = null;
                    renderProjects();
                } else if (target.matches('.cancel-delete-btn')) {
                    projectToDeleteId = null;
                    renderProjects();
                } else if (target.matches('.confirm-delete-btn')) {
                    const success = await deleteProject(projectId);
                    if (success) {
                        projects = projects.filter(p => p.project_id !== projectId);
                        projectToDeleteId = null;
                        renderProjects();
                    }
                } else if (target.matches('.cancel-edit-btn')) {
                    const project = projects.find(p => p.project_id === projectId);
                    if (project && !project.project_name && !project.description) {
                        projects = projects.filter(p => p.project_id !== projectId);
                    }
                    editingProjectId = null;
                    renderProjects();
                } else if (target.matches('.save-btn')) {
                    const card = target.closest('.project-card');
                    const projectIndex = projects.findIndex(p => p.project_id === projectId);
                    if (projectIndex === -1) return;

                    const originalProject = projects[projectIndex];
                    const updatedProject = { ...originalProject };
                    
                    const nameInput = card.querySelector('[data-field="projectName"]');
                    const descriptionInput = card.querySelector('[data-field="description"]');
                    nameInput.classList.remove('input-error');
                    descriptionInput.classList.remove('input-error');
                    
                    let isValid = true;
                    if (!nameInput.value.trim()) {
                        nameInput.classList.add('input-error');
                        isValid = false;
                    }
                    if (!descriptionInput.value.trim()) {
                        descriptionInput.classList.add('input-error');
                        isValid = false;
                    }
                    if (!isValid) return;

                    updatedProject.project_name = nameInput.value.trim();
                    updatedProject.description = descriptionInput.value.trim();
                    updatedProject.client = card.querySelector('[data-field="client"]').value.trim() || null;
                    updatedProject.startDate = card.querySelector('[data-field="startDate"]').value;
                    updatedProject.completedDate = card.querySelector('[data-field="completedDate"]').value || null;
                    
                    const newStatus = card.querySelector('[data-field="status"]').checked ? 'completed' : 'in-progress';
                    if (newStatus === 'completed' && originalProject.status !== 'completed') {
                         updatedProject.completedDate = new Date().toISOString().split('T')[0];
                    } else if (newStatus === 'in-progress' && originalProject.status === 'completed') {
                        updatedProject.completedDate = null;
                    }
                    updatedProject.status = newStatus;

                    const isNewProject = projectId.startsWith('proj_');

                    if (isNewProject) {
                        const newProjectFromServer = await createProject(updatedProject);
                        if (newProjectFromServer) {
                            editingProjectId = null;
                            await init();
                        }
                    } else {
                        const success = await saveProject(updatedProject);
                        if (success) {
                            projects[projectIndex] = updatedProject;
                            editingProjectId = null;
                            renderProjects();
                        }
                    }
                }
            });

            projectsGrid.addEventListener('change', (e) => {
                const card = e.target.closest('.project-card');
                // Only act if we are in edit mode for this card
                if (!card || card.dataset.projectId !== editingProjectId) return;

                if (e.target.matches('[data-field="status"]')) {
                    const statusText = card.querySelector('.status-text-edit');
                    if (statusText) {
                        statusText.textContent = e.target.checked ? 'Completed' : 'In Progress';
                    }
                }
            });

            // --- INITIALIZATION ---
            async function init() {
                // Initialize auth from localStorage
                authObject.init();
                
                // Set up periodic token validation (every 5 minutes)
                setInterval(() => {
                    if (authObject.token) {
                        authObject.isTokenValid(); // This will clear expired tokens
                    }
                }, 5 * 60 * 1000); // 5 minutes
                
                // Add logout button event listener
                document.getElementById('logout-btn').addEventListener('click', () => {
                    authObject.clearStoredAuth();
                    window.location.href = '/index.html';
                });
                
                projects = await fetchProjects();
                // Sort projects by start date, most recent first
                projects.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));
                renderProjects();
            }

            init();
        });
    </script>
</body>
</html>

